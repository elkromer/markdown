---
tags:
  - FTP
---

The FTP Model

                                            -------------
                                            |/---------\|
                                            ||   User  ||    --------
                                            ||Interface|<--->| User |
                                            |\----^----/|    --------
                  ----------                |     |     |
                  |/------\|  FTP Commands  |/----V----\|
                  ||Server|<---------------->|   User  ||
                  ||  PI  ||   FTP Replies  ||    PI   ||
                  |\--^---/|                |\----^----/|
                  |   |    |                |     |     |
      --------    |/--V---\|      Data      |/----V----\|    --------
      | File |<--->|Server|<---------------->|  User   |<--->| File |
      |System|    || DTP  ||   Connection   ||   DTP   ||    |System|
      --------    |\------/|                |\---------/|    --------
                  ----------                -------------

                  Server-FTP                   USER-FTP

The User-PI initiates the control connection. The control connections follows TELNET protocol. At the initiation of the user, commands are generated by the user-PI and tranmitted to the server process via the control connection. Standard replies are sent from the server-PI to the user-PI ove the control connection. The FTP commands specify information about the data connection (port, transfer mode, representation type, structure) and the nature of the file system operation (crud).

The user-DTP should listen on the data port and the server intiates the data connection and data transfer in accordance with commands from the user-PI.

FTP has a long evolution and underwent considerable changes between 1971-1974. At that time it used NCP as a transport protocol, RFC 765 in 1980 defined FTP for use over TCP. The latest spec for FTP over TCP is 959 written in 1985.

Often it is necessary to perform transformations of the data because data storage representations on the two systems are different. The sending and receiving sites would have to perform the necessary transformations between the standard representation and their internal representations. It is not always clear how the sender should send data and the receiver should store it. For example, when transmitting 32-bit bytes from a 32-bit word-length system to a 36-bit word-length system, what do? It may be desirable to right-justify the 32-bit bytes in a 36-bit word. FTP provides for very limited data type representations. Data representations are handled in FTP by a user specifying a logical byte size with the TYPE command. NVT-ASCII has a logical byte size of 8 bits by default, TYPE can take a second parameter specifying the logical byte size. The TRANSFER BYTE SIZE is always 8-bits.

FTP also allows file structure to be specified: 
  - file-structure: contiguous sequence of bytes
  - record-structure: sequential records
  - page-structure: independent indexed pages

The mechanics of transferring data consists of setting up the data connection to the appropriate ports and choosing the parameters for transfer. Both the user-DTP and server-DTP have a default data port. The user-process default data port is the same as the control connection port. The server-process default data port is the port adjacent to the control connection port. The user can specify an alternate data port with the PORT command. It is the server's responsibility to maintain the data connection--to initiate it and to close it. The exception to this is when the user-DTP is sending the data in a transfer mode that requires the connection to be closed to indicate EOF. The user-PI may request the server side to identify a non-default server side data port with the PASV command. 

Resuing the Data connection: In Stream mode, the end of file MUST be indicated by closing the connection. This causes problems if multiple files are to be transferred. There are two solutions here, either negotiate a non-default port or use another transfer mode. Note, all data transfers must be completed with an end-of-file which may be explicitly stated or implied by the closing of the data connection.

Transfer modes:
  - STREAM MODE:
    If the structure is file-structure, EOF is indicated by the sending host closing the data connection. In record-structure the EOF or EOR will be indicated by a two byte control code. 
  - BLOCK MODE:
  - COMPRESSED MODE:


Securing FTP with TLS
  FTP protocol insists that a USER command be used to identify the entity attempting to use the FTP server. Although TLS provides authentication infomration, the USER command must still be issued after TLS is negotiated. It is up to the server implementation to choose which credentials to accept.
  AUTH command is issued by the client to indicate the client wants a secured control session all commands afterwards are protected.
  To protect the data channel as well, the PBSZ command followed by the PROT command sequence must be used.
  CCC command clears TLS from the control connection and data connection.

Data Connection behavior:
  - Classic: Client obtains a data connection port; sends the port number to the server and the server connects to the client. The client issues control commands over the control connection. 
  - Firewall-Friendly: PASV command is issued by the client that requests the server open a port; the server obtains a port and returns an address and port number to the client; the client connects to the server on this port. 
  - Client-initiated server/server data exchange:

Notes:
Another valid FTP model:

                    Control     ------------   Control
                    ---------->| User-FTP |<-----------
                    |          | User-PI  |           |
                    |          |   "C"    |           |
                    V          ------------           V
            --------------                        --------------
            | Server-FTP |   Data Connection      | Server-FTP |
            |    "A"     |<---------------------->|    "B"     |
            -------------- Port (A)      Port (B) --------------
